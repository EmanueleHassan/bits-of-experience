<!DOCTYPE html>
<html prefix="        og: http://ogp.me/ns# article: http://ogp.me/ns/article#     " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Object Relational Mapping | Bits of Experience</title>
<link href="https://fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://marcohassan.github.io/bits-of-experience/posts/object-relational-mapping/">
<!--[if lt IE 9]><script src="../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><meta name="author" content="Marco Hassan">
<link rel="prev" href="../on-the-right-level-of-abstraction-to-think-the-system-at-high-level/" title="On the right level of abstraction to think the system at high level" type="text/html">
<link rel="next" href="../on-festina-lente/" title="On Festina Lente" type="text/html">
<meta property="og:site_name" content="Bits of Experience">
<meta property="og:title" content="Object Relational Mapping">
<meta property="og:url" content="https://marcohassan.github.io/bits-of-experience/posts/object-relational-mapping/">
<meta property="og:description" content="img {
display: block;
margin-top: 60px;
margin-bottom: 60px;
margin-left: auto;
margin-right: auto;
width: 70%;
height: 100%;
class: center;
}

.container {
  position: relative;
  left: 15%;
  margin">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-07-05T13:54:32+02:00">
<meta property="article:tag" content="Databases">
<meta property="article:tag" content="dev">
<meta property="article:tag" content="oop">
<meta property="article:tag" content="software-engineering">
</head>
<body>
    <a href="#page-content" class="sr-only sr-only-focusable">Skip to main content</a>
    
    <section class="social"><ul>
<li><a href="../../pages/aboutme/" title="About me"><i class="fa fa-user-circle"></i></a></li>
            <li><a href="../../pages/bits-of-experience-a-readable-view-on-my-study-adventures/" title="Home"><i class="fa fa-home"></i></a></li>
            <li><a href="../../index.html" title="Blog"><i class="fa fa-edit"></i></a></li>
            <li><a href="../../pages/emacs/" title="A life Configuring Emacs"><i class="fa fa-code"></i></a></li>
            <li><a href="../../pages/papers/" title="Term and Research Papers"><i class="fa fa-university"></i></a></li>
            <li><a href="../../pages/foto-blog/" title="Foto Blog"><i class="fa fa-camera-retro"></i></a></li>
            <li><a href="https://github.com/MarcoHassan" title="My Github"><i class="fab fa-github"></i></a></li>
            <li><a href="https://stackoverflow.com/users/9731177/mhass" title="My Stack"><i class="fab fa-stack-overflow"></i></a></li>
            <li><a href="../../rss.xml" title="RSS"><i class="fa fa-rss"></i></a></li>
            <li><a href="../../categories/index.html" title="Tags"><i class="fa fa-tags"></i></a></li>
    
    

        </ul></section><section class="page-content"><div class="content" rel="main">
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Object Relational Mapping</a></h1>

        <div class="metadata">
            <p class="dateline"><a href="." rel="bookmark"><i class="fa fa-clock"></i> <time class="published dt-published" datetime="2022-07-05T13:54:32+02:00" itemprop="datePublished" title="2022-07-05 13:54">2022-07-05 13:54</time></a></p>
            <p class="byline author vcard"> <i class="fa fa-user"></i> <span class="byline-name fn" itemprop="author">
                    Marco Hassan
            </span></p>
            
        <p class="sourceline"><a href="index.org" class="sourcelink"><i class="fa fa-file-code"></i> Source</a></p>

            

            
    <div class="tags">
<h3 class="metadata-title">
<i class="fa fa-tags"></i> Tags:</h3>
        <ul itemprop="keywords" class="tags-ul">
<li><a class="tag p-category" href="../../categories/databases/" rel="tag">Databases</a></li>
            <li><a class="tag p-category" href="../../categories/dev/" rel="tag">dev</a></li>
            <li><a class="tag p-category" href="../../categories/oop/" rel="tag">oop</a></li>
            <li><a class="tag p-category" href="../../categories/software-engineering/" rel="tag">software-engineering</a></li>
        </ul>
</div>

        </div>
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <style>

img {
display: block;
margin-top: 60px;
margin-bottom: 60px;
margin-left: auto;
margin-right: auto;
width: 70%;
height: 100%;
class: center;
}

.container {
  position: relative;
  left: 15%;
  margin-top: 60px;
  margin-bottom: 60px;
  width: 70%;
  overflow: hidden;
  padding-top: 56.25%; /* 16:9 Aspect Ratio */
  display:block;
  overflow-y: hidden;
}

.responsive-iframe {
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 100%;
  height: 100%;
  border: none;
  display:block;
  overflow-y: hidden;
}
</style>
<p>
So basically the idea of object relational mapping is the one of
mapping relational tables to objects.
</p>

<p>
The idea is that a lot of times the application logic is in objects
while the persistency layer is in the relational schema.
</p>

<p>
That translation is annoying and time consuming. Plus it requires a
mind switch to think at the two different levels.
</p>

<p>
The idea of this technology was essentially to develop a framework to
map the relational persistency layer to the ORM paradigm. In such a
way it is possible for the developer to wire his mind into a single
setting - the one of the objects and to properly develop in a pure
object oriented mind.
</p>

<p>
In this sense this is a lot what is happening in the NoSQL space,
especially with the document store and the json communication format
for API.. the underlying driver must is the same…. avoid all of that
annoying conversions from one paradigm to the other.
</p>

<p>
So you see; always think in terms of drivers… you will anticipate
the future once you focus on the underlying driver and force instead
of on the concept itself.
</p>

<p>
In general much of these notes refer to the <a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjbwuWh_eH4AhVDwQIHHW0vC9sQFnoECA8QAQ&amp;url=https%3A%2F%2Fhoclaptrinhdanang.com%2Fdownloads%2Fpdf%2Fspring%2FJava%2520Persistence%2520with%2520Hibernate.pdf&amp;usg=AOvVaw0524Xl7sPIrS85z5EARMyP">following book</a>.
</p>

<p>
Note as well that as always you can debate about everything and you
shuold think when ORM and Hibernate - in the specific case - is a good
candidate and when not. See <a href="https://www.eversql.com/i-followed-hibernate-orm-to-hell-and-came-back-alive-to-tell-about-it/">this dude</a> post in general - also check the
last section. There is interesting referenced material.
</p>

<!-- TEASER_END -->


<div id="outline-container-orgb18f228" class="outline-2">
<h2 id="orgb18f228">Important Concepts leading to ORM</h2>
<div class="outline-text-2" id="text-orgb18f228">
<p>
So this is very important.
</p>

<p>
It must sit in a very important way in your brain.
</p>

<p>
Cause this topic is very hot in the team and it is at least good
that you have an understanding of going into one direction or the
other.
</p>

<p>
So interesting to see is that much of the topics discussed that
follow come from thinking in terms of objects and the respective
shortcoming when going 
</p>
</div>


<div id="outline-container-org9d471d3" class="outline-3">
<h3 id="org9d471d3">Problem of Granularity</h3>
<div class="outline-text-3" id="text-org9d471d3">
<p>
The idea is that in the OOP world you have lots of level of
granularity through which you can create and shape your objects.
</p>

<p>
These are very important as through them you can create very
sophisticated business logic.
</p>

<p>
Now when working with SQL the point is essentially that such
<i>level of granularity is lost</i>.
</p>

<p>
It is generally not a big practice to work with <code>user-defined data
    types</code> in SQL relational DBs. You generally work at two level of
granularity - tables and columns with the SQL standard data
types. 
</p>

<p>
The key now is essentially the following:
</p>

<blockquote>
<p>
Many simple persistence mechanisms fail to recognize this mismatch and
so end up forcing the less flexible representation of SQL products on
the object-oriented model, effectively flattening it.
</p>
</blockquote>
</div>

<div id="outline-container-org65e21fe" class="outline-4">
<h4 id="org65e21fe">
<span class="todo TODO">TODO</span> the book claims for a solution to the above problem - find it and integrate it here then.</h4>
</div>
</div>


<div id="outline-container-orgd8da486" class="outline-3">
<h3 id="orgd8da486">The problem of Subtypes</h3>
<div class="outline-text-3" id="text-orgd8da486">
<p>
Essentially this is the problem of inheritance and polymorphism
and the fact that there is no way to really express this into a
relational database.
</p>

<p>
This makes everything quite tricky.
</p>

<p>
Essentially it is the following:
</p>


<img src="../../images/Screenshot%202022-07-05%20180342.png" class="center">
</div>
</div>


<div id="outline-container-org06b34e8" class="outline-3">
<h3 id="org06b34e8">The problem of Identity</h3>
<div class="outline-text-3" id="text-org06b34e8">
<p>
That is also quite an interesting one.
</p>

<p>
The idea is of a radical difference among the identity principles
in Java and the application side and on the relational DBs.
</p>

<p>
The concept is that in Java you have two different concepts of
identity:
</p>

<ul class="org-ul">
<li>== -&gt; checking by reference</li>

<li>.equals () -&gt; checking by value</li>
</ul>
<p>
While on the DB side you have the idea of checking by primary
key for checking the uniqueness of a record.
</p>

<p>
In this sense, understand as well the following concept that is
related to the concept of identity:
</p>

<img src="../../images/Screenshot%202022-07-06%20090604.png" class="center"><p>
Note that this is very likely related to the idea of not setting
any <code>setters</code> for the primary key columns in Hibernate. This is
the same underlying idea.
</p>

<p>
This is also why you also have an ID for the different tables and
use ultimately that one. It is the way to implement that concept
of <i>surrogate key</i> and this is why Sergio was so focused on it in
his introduction. I did not really get it properly to that stage. 
</p>
</div>
</div>


<div id="outline-container-org963dc6d" class="outline-3">
<h3 id="org963dc6d">The problem of association</h3>
<div class="outline-text-3" id="text-org963dc6d">
<p>
Object-oriented languages represent associations using object
references; but in the relational world, a <i>foreign key</i> –constrained
column represents an association, with copies of key values.
</p>

<p>
The constraint is a rule that guarantees integrity of the
association.  There are <i>substantial differences</i> between the two
mechanisms.
</p>

<p>
Object references are <i>directional</i>. Navigation in a particular
direction has no meaning for a relational data model because you
can create arbitrary data associations with join and projection
operators.
</p>

<p>
The important thing is <b>the following</b> then:
</p>

<blockquote>
<p>
The challenge is to map a completely open data model, which is
independent of the application that works with the data, to an
application-dependent navigational model.
</p>
</blockquote>
</div>
</div>


<div id="outline-container-orgf55a0ba" class="outline-3">
<h3 id="orgf55a0ba">The problem of data navigation</h3>
<div class="outline-text-3" id="text-orgf55a0ba">
<p>
So basically when working with ORM it is important to keep the
thing under control by not overloading the system with very
expensive queries fetching all of the possible data relations
across the object network in the mapped DB world.
</p>

<p>
The idea is the one of leveraging <i>lazy loading</i> as a solution as
discussed a couple of times:
</p>

<blockquote>
<p>
Any object persistence solution worth its salt provides
functionality for fetching the data of associated instances only
when the association is first accessed in Java code.  This is
known as lazy loading: retrieving data on demand only.
</p>
</blockquote>

<p>
Note that this is not a trivial problem. Cause on the other side
you have the following problem:
</p>

<blockquote>
<p>
This piecemeal style of data access is fundamentally inefficient [the
one of lazy loading] in the context of an SQL database, because it
requires executing one statement for each node or collection of the
object network that is accessed. This is the dreaded n+1 selects
problem - i.e. you actually perform too many queries killing the DB.
</p>
</blockquote>

<p>
So essentially you have the difficult problem:
</p>

<ul class="org-ul">
<li>avoid the <b>cartesian product</b> vs.  avoid <b>n+1 select</b> problem.</li>
</ul>
<p>
Not trivial to solve and decide at development time. 
</p>
</div>
</div>
</div>


<div id="outline-container-orgff2934f" class="outline-2">
<h2 id="orgff2934f">On Mapping Strategies</h2>
<div class="outline-text-2" id="text-orgff2934f">
</div>
<div id="outline-container-org745204c" class="outline-3">
<h3 id="org745204c">On Entity and Value Types</h3>
<div class="outline-text-3" id="text-org745204c">
<p>
So one of the most important factors, is the difference between
<b>entities and value types</b>. You have to understand when to map
objects in the first and second way. This is of paramount
importance. 
</p>
</div>

<div id="outline-container-org89cbaea" class="outline-4">
<h4 id="org89cbaea">On Entity Types</h4>
<div class="outline-text-4" id="text-org89cbaea">
<p>
You have to make this difference explicit when you work in the ORM
fashion. The main idea is the following:
</p>

<p>
In the <code>entity type</code> all of the objects of interest reference a
third <b>common</b> object: the <code>entity type</code>, i.e. an object that is
equal in <code>==</code> java terms.
</p>

<img src="../../images/Screenshot%202022-08-09%20152726.png" class="center"><p>
So here the key element that is important to understand is that the
relation in the case of the <code>entity type</code>, i.e. a pointer in the
JVM, is persisted as a reference in the DB, meaning a foreign
key-constrained value.
</p>

<p>
In this sense when the object is of <code>entity type</code> it is not
deleted when one of the object pointing to it is. This is because
of the idea that different object might use it and the idea that
in DB schema behind there are two tables and there is a foreign
key constraint. 
</p>
</div>
</div>


<div id="outline-container-org799d6a1" class="outline-4">
<h4 id="org799d6a1">On Value Types</h4>
<div class="outline-text-4" id="text-org799d6a1">
<p>
Here the idea is that, there are object that do not have to be
persisted as entity instance types as <a href="#org89cbaea">On Entity Types</a>, but rather
<b>belong</b> to an entity type. 
</p>

<p>
In this sense a <code>value type</code> has no persistent identifier
property it is rather bounded to the entity type object it
belongs to. When this is gone, the <code>value type</code> object is deleted
as well.
</p>

<img src="../../images/Screenshot%202022-08-09%20160450.png" class="center">
</div>
</div>
</div>


<div id="outline-container-org09c95a3" class="outline-3">
<h3 id="org09c95a3">Mapping entities with identities</h3>
<div class="outline-text-3" id="text-org09c95a3">
<p>
We start now with modeling the <code>entities</code>, in later chapters we go
then to the <code>value types</code>.
</p>

<p>
The idea is that as soon as you have an <code>entity type</code> object you
need an identifier for it.
</p>

<p>
This because such entity types objects will actually form the
basis for the tables to be persisted and they will need to contain
the relevant primary keys.
</p>

<p>
Hibernate as a framework also forces you behind the hood to work
with surrogate keys as discussed. These should stay as such and
should not turn into <i>natural keys</i>. This is important as
experience showed that natural keys cause problems in the long run.
</p>

<p>
In this sense when you create an <code>entity type</code>, you usually
specify an <code>Id</code> property with a corresponding rule for setting
it, say increase it etc. etc.
</p>

<p>
Then once this is set you will never update it, so there will be
<b>no setter</b>, rather just <b>getter</b> on it in order to get the
desired value. 
</p>

<p>
An example for it is the following:
</p>

<img src="../../images/Screenshot%202022-08-10%20094104.png" class="center"><p>
Note now that the following general rules:
</p>

<blockquote>
<p>
if @Id is on a field, the JPA provider will access fields of the class
directly and consider all fields part of the persistent state by
default.
</p>
</blockquote>

<blockquote>
<p>
Hibernate <b>doesn’t support updating primary key</b> values with an API; if
you try to work around this requirement, you’ll run into problems with
Hibernate’s caching and dirty-checking engine. If your database schema
relies on updatable primary keys (and maybe uses ON UPDATE CASCADE
foreign key constraints), you must change the schema before it will
work with Hibernate.
</p>
</blockquote>

<p>
Finally recall that it is important to get this right, as the
general rule is:
</p>

<blockquote>
<p>
Expect your database schema to survive decades, even if your
application won’t.
</p>
</blockquote>
</div>

<div id="outline-container-org1851b98" class="outline-4">
<h4 id="org1851b98">How to generate surrogate keys effectively</h4>
<div class="outline-text-4" id="text-org1851b98">
<p>
The starting point is the following:
</p>

<blockquote>
<p>
The @Id annotation is required to mark the identifier property of an
entity class. Without the @GeneratedValue next to it, the JPA
provider assumes that you’ll take care of creating and assigning an
identifier value before you save an instance.
</p>

<p>
JPA standardizes several value-generation strategies with the
javax.persistence.GenerationType enum, which you select with
@GeneratedValue(strategy = …):
</p>
</blockquote>

<p>
Among the options are:
</p>

<ul class="org-ul">
<li>
<p>
<code>GenerationType.AUTO</code>:
</p>

<p>
Hibernate picks an appropriate strategy, asking the SQL dialect
of your configured database what is best.
</p>
</li>

<li>
<p>
<code>GenerationType.SEQUENCE</code>:
</p>

<p>
Sequential numeric values.
</p>

<p>
Note the difference with the next one. I think the difference
lies in the <i>sequence</i>. A sequence can be quite general and
does not have to be the +1 sequence. In fact there are lower
level stuff happening depending on the SQL dialect you are
working with. 
</p>
</li>

<li>
<p>
<code>GenerationType.IDENTITY</code>:
</p>

<p>
special auto-incremented primary key column that automatically
generates a numeric value on INSERT.
</p>
</li>

<li>
<p>
<code>GenerationType.TABLE</code>:
</p>

<p>
Here you will have an extra table in your DB schema that holds
the numeric primary key value, one row for each entity
class. This table will be read and updated accordingly, before
INSERTs. The default table name is HIBERNATE<sub>SEQUENCES</sub> with
columns SEQUENCE<sub>NAME</sub> and SEQUENCE<sub>NEXT</sub><sub>HI</sub><sub>VALUE</sub>. 
</p>
</li>
</ul>
</div>
</div>





<div id="outline-container-org4633807" class="outline-4">
<h4 id="org4633807">How to name your tables</h4>
<div class="outline-text-4" id="text-org4633807">
<div class="highlight"><pre><span></span>     <span class="nd">@Entity</span> 
     <span class="nd">@Table</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"USERS"</span><span class="p">)</span> 
     <span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span> 
      <span class="c1">// ...</span>
     <span class="p">}</span>
</pre></div>

<p>
Note that by default if you do not specify a name the name is
specified according to the Object the Entity annotation is
bounded to.
</p>

<p>
Note now that the above is a good example, as the User entity
would map to the USER table; this is a reserved keyword in most
SQL DBMSs. You can’t have a table with that name, so you instead
map it to USERS.
</p>

<p>
There are then tricks in order to generally deal with reserved
keywords. Skip it for now. There are as well ways to enforce
naming convetions across your tables names. 
</p>
</div>
</div>


<div id="outline-container-org142cd21" class="outline-4">
<h4 id="org142cd21">Naming Entities for Querying</h4>
<div class="outline-text-4" id="text-org142cd21">
<p>
The idea is that:
</p>

<blockquote>
<p>
all entity names are automatically imported into the namespace of the
query engine.
</p>

<p>
In other words, you can use short class names <b>without a package prefix</b>
in JPA query strings.
</p>
</blockquote>

<p>
Note now that if you have two entity classes named in the <b>same
way</b> in <b>two different packages</b> then you need to rename one of
them for JPA - through the name property as above - if you want
to continue using the short form queries, such as:
</p>

<div class="highlight"><pre><span></span>     <span class="n">List</span> <span class="n">result</span> <span class="o">=</span> <span class="n">em</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="s">"select i from Item i"</span><span class="p">)</span>
      <span class="p">.</span><span class="na">getResultList</span><span class="p">();</span>
     <span class="c1">// where Item is the shortname and is an Entity in Hibernate</span>
</pre></div>
</div>
</div>


<div id="outline-container-org7277f4c" class="outline-4">
<h4 id="org7277f4c">Dynamic SQL generation</h4>
<div class="outline-text-4" id="text-org7277f4c">
<p>
Here the idea is
</p>

<blockquote>
<p>
By default, Hibernate creates SQL statements for each persistent
class when the persistence unit is created, on startup. These
statements are simple create, read, update, and delete (CRUD)
operations for reading a single row, deleting a row, and so on.
</p>
</blockquote>

<p>
So the idea is that such statements are stored in memory instead
of being generated on the fly. This is computationally cheaper.
</p>

<p>
The tricky bit comes with the <code>UPDATE</code> statements.
</p>

<blockquote>
<p>
After all, the columns to be updated aren’t known at this time. The
answer is that the generated SQL statement updates all columns, and if
the value of a particular column isn’t modified, the statement sets it
to its old value.  In some situations, such as a legacy table with
hundreds of columns where the SQL statements will be large for even
the simplest operations (say, only one column needs updating), you
should disable this startup SQL generation and switch to dynamic
statements generated at runtime.
</p>

<p>
An <b>extremely large number of entities</b> can also impact startup
time, because Hibernate has to generate all SQL statements for
CRUD up front.  Memory consumption for this query statement cache
will also be high if a dozen statements must be cached for
thousands of entities. This can be an issue in virtual
environments with memory limitations, or on low-power devices.
</p>
</blockquote>

<p>
So keep these points in the back of the mind when creating your
Hibernate instances.
</p>

<p>
In order to disable such default behaviour you can use the
following:
</p>

<div class="highlight"><pre><span></span>     <span class="nd">@Entity</span> 
     <span class="nd">@org.hibernate.annotations.DynamicInsert</span>
     <span class="nd">@org.hibernate.annotations.DynamicUpdate</span>
     <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="p">{</span>
      <span class="c1">// ... </span>
     <span class="p">}</span>
</pre></div>
</div>
</div>


<div id="outline-container-org5b6c9f1" class="outline-4">
<h4 id="org5b6c9f1">Immutable types</h4>
<div class="outline-text-4" id="text-org5b6c9f1">
<p>
There might be objects which logic is <b>immutable</b>.
</p>

<p>
Think for instance a Bid in an auction. Once it is there, it is
there, you cannot modify it.
</p>

<p>
You can specify this immutable property as follows:
</p>

<div class="highlight"><pre><span></span>     <span class="nd">@Entity</span>
     <span class="nd">@org.hibernate.annotations.Immutable</span>
     <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Bid</span> <span class="p">{</span>
      <span class="c1">// ...</span>
     <span class="p">}</span>
</pre></div>

<p>
Then you will never be able to execute <code>UPDATE</code> statements on
such table.
</p>
</div>
</div>
</div>


<div id="outline-container-org64af6ae" class="outline-3">
<h3 id="org64af6ae">Mapping Value Types Objects</h3>
<div class="outline-text-3" id="text-org64af6ae">
<p>
Let's start again with the key point; this is fundamental as if
you fail here, you will fail in your DB design.
</p>

<p>
This is the following:
</p>

<blockquote>
<ul class="org-ul">
<li>Entities are the coarser-grained classes of your system. Their
instances have an independent life cycle and their own identity, and
many other instances can reference them.</li>

<li>Value types, on the other hand, are dependent on a particular entity
class. A value type instance is bound to its owning entity instance,
and only one entity instance can reference it; it has no individual
identity</li>
</ul>
</blockquote>

<p>
So that is the big difference that you have to make when working
with objects. Objects that are a property of an entity type,
belong to <code>value types</code>.
</p>

<p>
So, far when talking about <code>value types</code> we made the explicit
connection to embedded objects as discussed above.
</p>

<p>
Note that it is not important if the Object is programmer-defined
or coming from some standard library. Everything embedded within
an Entity Object is a <code>value type</code> Object.
</p>

<p>
So basically, the book starts with the <i>Numeric Objects</i> in the
Java language and other very common data Objects through which you
implement the basics of any program. It shows how these are
converted to SQL data types. You can read this online when needed.
</p>

<p>
More interesting are the following concepts:
</p>
</div>

<div id="outline-container-orge1f8282" class="outline-4">
<h4 id="orge1f8282">
<code>transient</code> keyword</h4>
<div class="outline-text-4" id="text-orge1f8282">
<p>
this is used to mark properties of the Object of interest that
should be discarded; meaning not persisted.
</p>

<p>
This will allow you to implement some cool application logic.
</p>

<div class="highlight"><pre><span></span>     <span class="kd">class</span> <span class="nc">Ob</span> <span class="p">{</span>
	 <span class="c1">// ...</span>

	 <span class="nd">@javax.persistence.Transient</span>
	     <span class="n">Integer</span> <span class="n">myTransientInteger</span><span class="p">;</span>

	 <span class="c1">// ...</span>
     <span class="p">}</span>
</pre></div>
</div>
</div>

<div id="outline-container-org4970caf" class="outline-4">
<h4 id="org4970caf">non-optional</h4>
<div class="outline-text-4" id="text-org4970caf">
<p>
When you mark a property with this tag it will be marked as <code>NOT
     NULL</code> in the DB schema.
</p>

<div class="highlight"><pre><span></span>     <span class="kd">class</span> <span class="nc">Ob</span> <span class="p">{</span>
	 <span class="c1">// ...</span>

     <span class="nd">@Basic</span><span class="p">(</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
     <span class="n">BigDecimal</span> <span class="n">initialPrice</span><span class="p">;</span>

	 <span class="c1">// ...</span>
     <span class="p">}</span>
</pre></div>

<p>
Another option in this sense is to include this in the <code>@Column</code>
property.
</p>

<div class="highlight"><pre><span></span>     <span class="kd">class</span> <span class="nc">Ob</span> <span class="p">{</span>
	 <span class="c1">// ...</span>

	 <span class="nd">@Column</span><span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"BlaBla"</span><span class="p">)</span> <span class="c1">// so you see. You can as well name the column.</span>
	 <span class="n">BigDecimal</span> <span class="n">initialPrice</span><span class="p">;</span>

	 <span class="c1">// Note that Column has as well parameters for controlling the schema and catalog properties.</span>

	 <span class="c1">// ...</span>
     <span class="p">}</span>
</pre></div>

<p>
Finally there is the way of working with <code>@NotNull</code>, this will
make the thing not-nullable through Bean Validation. I.e. at
runtime you will get errors.
</p>

<p>
You will not have the not-null property in your DB schema. So it
depends what you want to do. However, in general it is not
recommended to do any of this.
</p>
</div>
</div>

<div id="outline-container-org02c8289" class="outline-4">
<h4 id="org02c8289">On @Embedded classes</h4>
<div class="outline-text-4" id="text-org02c8289">
<p>
Basically recall that depending on where you set the <code>@Id</code>
property:
</p>

<ul class="org-ul">
<li>either on a field</li>

<li>or on a getter</li>
</ul>
<p>
then this will be the strategy for reading and writing from the
DB.
</p>

<p>
Now <code>@Embedded</code> classes are the actual <code>value types</code> objects you
write.
</p>

<p>
That said, they will inherit the mapping strategy for reading and
writing of the <code>entity types</code> objects they are bounded to.
</p>

<p>
In case you want to override such a strategy you can use the
<code>@Access</code> annotation. This can be both at class level or at
property level within the embedded class.
</p>

<p>
Note that when you embedd a class you are actually augmenting the
relevant table with all of the relevant fields.
</p>

<p>
Note that you might want to override the <code>equals</code> and <code>hashCode</code>
cause you have to start comparing by values and not by reference.
</p>

<p>
An important thing to remember when working in such a way is the
one of overriding embedded attributes. This is important as you
might have for instance two addresses and if you do not override
the respective names you would have conflicts and you could not
work in the same table. 
</p>

<div class="highlight"><pre><span></span>      <span class="nd">@Entity</span>
      <span class="nd">@Table</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"USERS"</span><span class="p">)</span>
      <span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

	  <span class="nd">@Embedded</span>
	  <span class="nd">@AttributeOverrides</span><span class="p">({</span>
		  <span class="nd">@AttributeOverride</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"street"</span><span class="p">,</span>
				     <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"BILLING_STREET"</span><span class="p">)),</span>
		      <span class="nd">@AttributeOverride</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"zipcode"</span><span class="p">,</span>
					 <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"BILLING_ZIPCODE"</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)),</span>
		      <span class="nd">@AttributeOverride</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"city"</span><span class="p">,</span>
					 <span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"BILLING_CITY"</span><span class="p">))</span>
		      <span class="p">})</span>

		      <span class="kd">protected</span> <span class="n">Address</span> <span class="n">billingAddress</span><span class="p">;</span> 

     <span class="c1">// ...</span>

     <span class="p">}</span>
</pre></div>

<p>
You can then check at the book. You can as well have nested relations.
</p>
</div>
</div>

<div id="outline-container-orgaef96c5" class="outline-4">
<h4 id="orgaef96c5">Derived properties</h4>
<div class="outline-text-4" id="text-orgaef96c5">
<p>
So basically in this way you can apply transformations <b>when
fetching</b> the object from the database.
</p>

<div class="highlight"><pre><span></span>      <span class="nd">@org.hibernate.annotations.Formula</span><span class="p">(</span>
       <span class="s">"substr(DESCRIPTION, 1, 12) || '...'"</span>
      <span class="p">)</span>
      <span class="kd">protected</span> <span class="n">String</span> <span class="n">shortDescription</span><span class="p">;</span>
      <span class="nd">@org.hibernate.annotations.Formula</span><span class="p">(</span>
       <span class="s">"(select avg(b.AMOUNT) from BID b where b.ITEM_ID = ID)"</span>
      <span class="p">)</span>
      <span class="kd">protected</span> <span class="n">BigDecimal</span> <span class="n">averageBidAmount</span><span class="p">;</span>
</pre></div>

<p>
Note that this is just for reading. <code>ColumnTransformer</code>
described in the next section is both for reading and writing. 
</p>
</div>
</div>

<div id="outline-container-org77ebecd" class="outline-4">
<h4 id="org77ebecd">Transforming column values</h4>
<div class="outline-text-4" id="text-org77ebecd">
<p>
You can apply transformations for reading and writing from/in
the database as follows:
</p>

<div class="highlight"><pre><span></span>      <span class="nd">@Column</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"IMPERIALWEIGHT"</span><span class="p">)</span>
      <span class="nd">@org.hibernate.annotations.ColumnTransformer</span><span class="p">(</span>
       <span class="n">read</span> <span class="o">=</span> <span class="s">"IMPERIALWEIGHT / 2.20462"</span><span class="p">,</span>
       <span class="n">write</span> <span class="o">=</span> <span class="s">"? * 2.20462"</span>
      <span class="p">)</span>
      <span class="kd">protected</span> <span class="kt">double</span> <span class="n">metricWeight</span><span class="p">;</span>
</pre></div>

<p>
Note that such transformations are as well applied in DB
queries restrictions.
</p>

<p>
Think for instance at the following:
</p>

<div class="highlight"><pre><span></span>      <span class="n">List</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span>
       <span class="n">em</span><span class="p">.</span><span class="na">createQuery</span><span class="p">(</span><span class="s">"select i from Item i where i.metricWeight = :w"</span><span class="p">)</span>
       <span class="p">.</span><span class="na">setParameter</span><span class="p">(</span><span class="s">"w"</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
       <span class="p">.</span><span class="na">getResultList</span><span class="p">();</span>

      <span class="c1">// The actual SQL executed by Hibernate for this query contains the</span>
      <span class="c1">// following restriction in the WHERE clause: ...</span>
      <span class="n">where</span>
       <span class="n">i</span><span class="p">.</span><span class="na">IMPERIALWEIGHT</span> <span class="o">/</span> <span class="mf">2.20462</span><span class="o">=?</span>
</pre></div>

<p>
Note that you will not be able to use <b>indices</b> on such queries
restrictions. This because all of the values will have to be
calculated. This will cause in fact a <i>full table scan</i>, because
the values have to be calculated for all rows before evaluating
the restriction.
</p>

<p>
So you see you have pro and cons when working with
Hibernate. There are things you should consider as well. 
</p>
</div>


<ul class="org-ul">
<li>
<a id="org629c46f"></a><span class="todo TODO">TODO</span> understand if you can implement this as well with a setter and reader<br><div class="outline-text-5" id="text-org629c46f">
<p>
theoretically you can as well make the transformation there.
</p>

<p>
double check but I think that it is possible and like this you
will decrease the amount of tools that you are actually using. 
</p>
</div>
</li>
</ul>
</div>




<div id="outline-container-orgb8837d6" class="outline-4">
<h4 id="orgb8837d6">Generating Values</h4>
<div class="outline-text-4" id="text-orgb8837d6">
<p>
With this tag you can Hibernate can automatically generate the
values for the fields when interacting with the Database.
</p>

<div class="highlight"><pre><span></span>     <span class="nd">@Temporal</span><span class="p">(</span><span class="n">TemporalType</span><span class="p">.</span><span class="na">TIMESTAMP</span><span class="p">)</span>
     <span class="nd">@Column</span><span class="p">(</span><span class="n">insertable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="c1">// note both false, meaning just the DB can generate them. User cannot.</span>
     <span class="nd">@org.hibernate.annotations.Generated</span><span class="p">(</span>
					  <span class="n">org</span><span class="p">.</span><span class="na">hibernate</span><span class="p">.</span><span class="na">annotations</span><span class="p">.</span><span class="na">GenerationTime</span><span class="p">.</span><span class="na">ALWAYS</span>
					  <span class="p">)</span>
	 <span class="kd">protected</span> <span class="n">Date</span> <span class="n">lastModified</span><span class="p">;</span>
     <span class="nd">@Column</span><span class="p">(</span><span class="n">insertable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
     <span class="nd">@org.hibernate.annotations.ColumnDefault</span><span class="p">(</span><span class="s">"1.00"</span><span class="p">)</span>
	 <span class="nd">@org.hibernate.annotations.Generated</span><span class="p">(</span>
					      <span class="n">org</span><span class="p">.</span><span class="na">hibernate</span><span class="p">.</span><span class="na">annotations</span><span class="p">.</span><span class="na">GenerationTime</span><span class="p">.</span><span class="na">INSERT</span>
					      <span class="p">)</span>
	 <span class="kd">protected</span> <span class="n">BigDecimal</span> <span class="n">initialPrice</span><span class="p">;</span>
</pre></div>

<p>
This is convenient for instance for generating timestamps for the
insertion into the DB.
</p>

<p>
Note the following:
</p>

<blockquote>
<p>
With ALWAYS, Hibernate refreshes the entity instance after every
SQL UPDATE or INSERT
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orge52c58e" class="outline-4">
<h4 id="orge52c58e">Enumerator</h4>
<div class="outline-text-4" id="text-orge52c58e">
<p>
Note that this is important when working with Enumerators
Objects.
</p>

<p>
If you wod not work with this property then you will save the
ordinal position of the value of within the enumerator.
</p>

<p>
In order to perform transactions with the enumerator label you
should use the <code>EnumType.STRING</code> option.
</p>

<div class="highlight"><pre><span></span>     <span class="nd">@NotNull</span>
     <span class="nd">@Enumerated</span><span class="p">(</span><span class="n">EnumType</span><span class="p">.</span><span class="na">STRING</span><span class="p">)</span>
     <span class="kd">protected</span> <span class="n">AuctionType</span> <span class="n">auctionType</span> <span class="o">=</span> <span class="n">AuctionType</span><span class="p">.</span><span class="na">HIGHEST_BID</span><span class="p">;</span>
</pre></div>
</div>
</div>

<div id="outline-container-org52c3372" class="outline-4">
<h4 id="org52c3372">String</h4>
<div class="outline-text-4" id="text-org52c3372">
<p>
Note that Strings are mapped ot VARCHAR(255) by default. If you
do not want this default but rather a different value you have to
set it in the <code>length</code> paramter.
</p>
</div>
</div>
</div>


<div id="outline-container-org4d25afa" class="outline-3">
<h3 id="org4d25afa">Mapping Inheritance</h3>
<div class="outline-text-3" id="text-org4d25afa">
<p>
This is an important concept as here is where things get
tricky.
</p>

<p>
The tricky business is always the same, you start to have OOP
concepts such as polymorphism and the way you map such OOP
characterstics into your relational tables is a non-trivial task
that requires a bit of thinking.
</p>

<p>
Essentially you have 4 possibilties, depending on the structure of
your application logic you might want to go for the one or the
other.
</p>

<p>
We will explore them further next, before let's quickly dive in
the concepts of <code>polymorphic associations</code> and <code>polymorphic
    queries</code>. These are essential cause you have to think what you get
from working in one way or the other.
</p>
</div>

<div id="outline-container-org6597979" class="outline-4">
<h4 id="org6597979">Polymorphic Associations</h4>
<div class="outline-text-4" id="text-org6597979">
<p>
So here the idea is the following:
</p>

<blockquote>
<p>
A polymorphic association consists on two (or more) associations
happening with the same foreign key.
</p>
</blockquote>

<p>
Such that if <code>polymorphic_association = true</code> you essentially
have repsected the superclass-subclass relations in your DB.
</p>

<p>
You would essentially have a table mapping to the superclass and
then it is clear that if you have different tables for your
subclasses that will reference the superclass via the foreign key
you would have a polymorphic association and with the key of the
superclass you will be able to fetch all of the relevant
associations in the subclasses.
</p>

<p>
You will see that depending on the mapping strategy this is not
always achieved and you should consider if it is fine to you or
not. 
</p>
</div>
</div>


<div id="outline-container-org253deb7" class="outline-4">
<h4 id="org253deb7">Polymorphic Queries</h4>
<div class="outline-text-4" id="text-org253deb7">
<p>
Think again in terms of OOP.
</p>

<p>
The idea when working with ORM is the concept of working always
with Objects when working in the relational space.
</p>

<p>
In JPA you have as well ways to query your data and fetch the
relevant information through APIs built around Objects mapped to
the relational space.
</p>

<p>
The idea of polymorphic queries is the following then:
</p>

<blockquote>
<p>
The <b>from</b> clause of a query includes not only instances of the
specific entity class to which it refers, but all subclasses of that
class as well. The instances returned by a query include instances of
the subclasses that satisfy the query conditions.
</p>
</blockquote>
</div>
</div>


<div id="outline-container-orge1c0363" class="outline-4">
<h4 id="orge1c0363">General set up for the following exercise</h4>
<div class="outline-text-4" id="text-orge1c0363">
<p>
Note that in the following we will discuss mapping strategies for
the BillingDetails and its subclasses.
</p>

<p>
The general set up for it is the following:
</p>

<img src="../../images/Screenshot%202022-08-17%20113654.png" class="center">
</div>
</div>


<div id="outline-container-orge3f7d18" class="outline-4">
<h4 id="orge3f7d18">One table per concrete class with implicit polymorphism</h4>
<div class="outline-text-4" id="text-orge3f7d18">
<p>
So this is the first possibility.
</p>

<p>
Note that the name given in the book is not that intuitive for
the concept behind it.
</p>

<p>
What you are actually doing here according to my opinion is
ultimately <i>breaking the polymorphism</i>. You actually see it by
the fact that in this mapping strategy you actually do not have
<i>polymorphic associations</i> and the possibility of performing
<i>polymorphic queries</i>.
</p>

<p>
The conceptual idea in this kind of mapping is the following:
</p>

<img src="../../images/Screenshot%202022-08-17%20112758.png" class="center"><p>
So you see that there is no table for the superclass but rather
its properties are persisted within the respective two tables
mapping to the subclasses.
</p>

<p>
You actually implement the above in the following way:
</p>

<div class="highlight"><pre><span></span>     <span class="nd">@MappedSuperclass</span> <span class="c1">// IMPORTANT; include this in the superclass</span>
		       <span class="c1">// otherwise the properties of the superclass will</span>
		       <span class="c1">// not be PERSISTED to the subclasses-entity models</span>
     <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BillingDetails</span> <span class="p">{</span>
	 <span class="nd">@NotNull</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">owner</span><span class="p">;</span>
	 <span class="c1">// ...</span>
     <span class="p">}</span>

     <span class="c1">// Subclass table, extending superclass and being mapped through the</span>
     <span class="c1">// Entity tag.</span>
     <span class="nd">@Entity</span>
     <span class="nd">@AttributeOverride</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"owner"</span><span class="p">,</span>  <span class="c1">// need to change name otherwise</span>
					 <span class="c1">// possible conflicts when</span>
					 <span class="c1">// evolving your schema</span>
			<span class="n">column</span> <span class="o">=</span> <span class="nd">@Column</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CC_OWNER"</span><span class="p">,</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">))</span>
     <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreditCard</span> <span class="kd">extends</span> <span class="n">BillingDetails</span> <span class="p">{</span>
	 <span class="nd">@Id</span>
	 <span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">generator</span> <span class="o">=</span> <span class="n">Constants</span><span class="p">.</span><span class="na">ID_GENERATOR</span><span class="p">)</span>
	 <span class="kd">protected</span> <span class="n">Long</span> <span class="n">id</span><span class="p">;</span>
	 <span class="nd">@NotNull</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">cardNumber</span><span class="p">;</span>
	 <span class="nd">@NotNull</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">expMonth</span><span class="p">;</span>
	 <span class="nd">@NotNull</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">expYear</span><span class="p">;</span>
	 <span class="c1">// ...</span>
     <span class="p">}</span>
</pre></div>


<p>
Let's reason now around:
</p>

<ul class="org-ul">
<li>
<p>
polymorphic associations:
</p>

<p>
So it is clear that here there is no polymorphic
association. All subclasses are mapped to different tables such
that there might not be an association to their superclass that
can be represented by a single foreign key relation.
</p>
</li>

<li>
<p>
polymorphic queries:
</p>

<p>
note that this is also not possible.
</p>

<p>
If you want to query upon the field of the superclass, here the
owner property you should make <b>multiple</b> queries - one for
each concrete subclass.
</p>
</li>
</ul>
</div>
</div>


<div id="outline-container-orgfa5ae5a" class="outline-4">
<h4 id="orgfa5ae5a">One table per concrete class with unions</h4>
<div class="outline-text-4" id="text-orgfa5ae5a">
<p>
So here the essential idea is to have at the relational level the
same schema as above.
</p>

<p>
The difference lies in the fact that in order to apply your
polymorphic operations at the superclass level you do not have to
make separate queries, fetch the results and merge them at
runtime in your java application as in the previous case.
</p>

<p>
You can rather apply directly <b>ploymorphic queries</b> and let your
database optimizer actually find the best execution plan.
</p>

<p>
In order to work in such a way you can use the following:
</p>

<div class="highlight"><pre><span></span>     <span class="c1">// Note here the entity tag and the inheritancetype TABLE_PER_CLASS.</span>
     <span class="c1">// Note as well that actually no table for the superclass is</span>
     <span class="c1">// created. As mentioned the schema is the same as in the previous</span>
     <span class="c1">// section.</span>
     <span class="nd">@Entity</span>
     <span class="nd">@Inheritance</span><span class="p">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">InheritanceType</span><span class="p">.</span><span class="na">TABLE_PER_CLASS</span><span class="p">)</span>
     <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BillingDetails</span> <span class="p">{</span>

	 <span class="nd">@Id</span>
	 <span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">generator</span> <span class="o">=</span> <span class="n">Constants</span><span class="p">.</span><span class="na">ID_GENERATOR</span><span class="p">)</span>
	 <span class="kd">protected</span> <span class="n">Long</span> <span class="n">id</span><span class="p">;</span>
	 <span class="nd">@NotNull</span>

	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">owner</span><span class="p">;</span>
	 <span class="c1">// ...</span>

     <span class="p">}</span>
</pre></div>


<p>
The subclasses would then look as usual. Simply extending the
superclass above.
</p>

<p>
As mentioned this would allow polymorphic queries; such that
writing queries as:
</p>

<div class="highlight"><pre><span></span>     <span class="k">select</span> <span class="n">bd</span> <span class="k">from</span> <span class="n">BillingDetails</span> <span class="n">bd</span>

     <span class="c1">---- would be translated by the Hibernate engine behind the scenes into:</span>

     <span class="k">select</span>
     <span class="n">ID</span><span class="p">,</span> <span class="k">OWNER</span><span class="p">,</span> <span class="n">EXPMONTH</span><span class="p">,</span> <span class="n">EXPYEAR</span><span class="p">,</span> <span class="n">CARDNUMBER</span><span class="p">,</span>
     <span class="n">ACCOUNT</span><span class="p">,</span> <span class="n">BANKNAME</span><span class="p">,</span> <span class="n">SWIFT</span><span class="p">,</span> <span class="n">CLAZZ_</span>
     <span class="k">from</span>
     <span class="p">(</span> <span class="k">select</span>
     <span class="n">ID</span><span class="p">,</span> <span class="k">OWNER</span><span class="p">,</span> <span class="n">EXPMONTH</span><span class="p">,</span> <span class="n">EXPYEAR</span><span class="p">,</span> <span class="n">CARDNUMBER</span><span class="p">,</span>
     <span class="k">null</span> <span class="k">as</span> <span class="n">ACCOUNT</span><span class="p">,</span>
     <span class="k">null</span> <span class="k">as</span> <span class="n">BANKNAME</span><span class="p">,</span>
     <span class="k">null</span> <span class="k">as</span> <span class="n">SWIFT</span><span class="p">,</span>
     <span class="mi">1</span> <span class="k">as</span> <span class="n">CLAZZ_</span>           <span class="c1">-- note this that classifies which table the results come from</span>
     <span class="k">from</span>
     <span class="n">CREDITCARD</span>
     <span class="k">union</span> <span class="k">all</span>
     <span class="k">select</span>
     <span class="n">id</span><span class="p">,</span> <span class="k">OWNER</span><span class="p">,</span>
     <span class="k">null</span> <span class="k">as</span> <span class="n">EXPMONTH</span><span class="p">,</span>
     <span class="k">null</span> <span class="k">as</span> <span class="n">EXPYEAR</span><span class="p">,</span>
     <span class="k">null</span> <span class="k">as</span> <span class="n">CARDNUMBER</span><span class="p">,</span>
     <span class="n">ACCOUNT</span><span class="p">,</span> <span class="n">BANKNAME</span><span class="p">,</span> <span class="n">SWIFT</span><span class="p">,</span>
     <span class="mi">2</span> <span class="k">as</span> <span class="n">CLAZZ_</span>           <span class="c1">-- note this that classifies which table the results come from</span>
     <span class="k">from</span>
     <span class="n">BANKACCOUNT</span>
     <span class="p">)</span> <span class="k">as</span> <span class="n">BILLINGDETAILS</span>
</pre></div>
</div>
</div>


<div id="outline-container-org1d3ad43" class="outline-4">
<h4 id="org1d3ad43">One table per class hierarchy</h4>
<div class="outline-text-4" id="text-org1d3ad43">
<p>
Here the mapping strategy would result in the following:
</p>

<img src="../../images/Screenshot%202022-08-17%20143159.png" class="center"><p>
So essentially here the idea is the following:
</p>

<blockquote>
<p>
You can map an entire class hierarchy <i>to a single table</i>. This table
includes columns for all properties of all classes in the
hierarchy.
</p>

<p>
The value of an extra type <b>discriminator column</b> or formula identifies
the concrete subclass represented.
</p>
</blockquote>

<p>
Understand now the merits and drawbacks:
</p>

<ul class="org-ul">
<li>
<p>
On the good side.
</p>

<blockquote>
<p>
This mapping strategy is a winner in terms of both performance and
simplicity.
</p>

<p>
It’s the best-performing way to represent polymorphism—both
polymorphic and non-polymorphic queries perform well—and it’s even
easy to write queries by hand.
</p>

<p>
Ad hoc reporting is possible without complex joins or unions. Schema
evolution is straightforward.
</p>
</blockquote>

<p>
Note that polymorphic queries are straightforward as in the
specific case the <code>owner</code> is just a field. It is
straightforward to apply <code>selection</code> and get all of the desired
results of, among the others, the subclasses.
</p>
</li>

<li>
<p>
Issues:
</p>

<blockquote>
<p>
There is <b>first major issue</b>: data integrity.
</p>

<p>
You must declare columns for properties declared by subclasses
to be nullable. If your subclasses each define several
non-nullable properties, the loss of NOT NULL constraints may
be a serious problem from the point of view of data
correctness.
</p>

<p>
Imagine that an expiration date for credit cards is required,
but your database schema can’t enforce this rule because all
columns of the table can be NULL. A simple application
programming error can lead to invalid data.
</p>

<p>
There is <b>second major issue</b>: normalization.
</p>

<p>
You’ve created <b>functional dependencies</b> between non-key
columns, <b>violating the third normal form</b>.
</p>

<p>
As always, denormalization for performance reasons can be
misleading, because it sacrifices <b>long-term stability</b>,
<b>maintainability</b>, and the <b>integrity of data</b>.
</p>

<p>
This is important as well. Before starting to design your DB
you should properly think about what normal form you want to
reach such that you will make sure that in the long run
maintainability will not be a major concern.
</p>
</blockquote>

<p>
Should you want to go for this mapping strategy you can
implement it in Hibernate as follows:
</p>

<div class="highlight"><pre><span></span>       <span class="nd">@Entity</span>
       <span class="nd">@Inheritance</span><span class="p">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">InheritanceType</span><span class="p">.</span><span class="na">SINGLE_TABLE</span><span class="p">)</span> <span class="c1">// on the root class.</span>
       <span class="nd">@DiscriminatorColumn</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"BD_TYPE"</span><span class="p">)</span>                <span class="c1">// this is a</span>
       <span class="c1">// discriminator</span>
       <span class="c1">// column</span>
       <span class="c1">// distinguishing</span>
       <span class="c1">// among the</span>
       <span class="c1">// subclasses</span>
       <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BillingDetails</span> <span class="p">{</span>

	   <span class="nd">@Id</span>
	   <span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">generator</span> <span class="o">=</span> <span class="n">Constants</span><span class="p">.</span><span class="na">ID_GENERATOR</span><span class="p">)</span>
	   <span class="kd">protected</span> <span class="n">Long</span> <span class="n">id</span><span class="p">;</span>

	   <span class="nd">@NotNull</span>
	   <span class="nd">@Column</span><span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
	   <span class="kd">protected</span> <span class="n">String</span> <span class="n">owner</span><span class="p">;</span>
	   <span class="c1">// ...</span>
       <span class="p">}</span>

       <span class="c1">// Example of subclass - see the discriminator value that you set</span>
       <span class="c1">// here.</span>
       <span class="nd">@Entity</span>
       <span class="nd">@DiscriminatorValue</span><span class="p">(</span><span class="s">"CC"</span><span class="p">)</span> 
       <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreditCard</span> <span class="kd">extends</span> <span class="n">BillingDetails</span> <span class="p">{</span>

	   <span class="nd">@NotNull</span>                        <span class="c1">// Hibernate ignores the @NotNull</span>
					   <span class="c1">// for schema DDL generation, but</span>
					   <span class="c1">// it observes it at runtime</span>
	   <span class="kd">protected</span> <span class="n">String</span> <span class="n">cardNumber</span><span class="p">;</span>

	   <span class="nd">@NotNull</span>
	   <span class="kd">protected</span> <span class="n">String</span> <span class="n">expMonth</span><span class="p">;</span>

	   <span class="nd">@NotNull</span>
	   <span class="kd">protected</span> <span class="n">String</span> <span class="n">expYear</span><span class="p">;</span>

	   <span class="c1">// ...</span>

       <span class="p">}</span>
</pre></div>

<p>
A final point that is worth to mention is the following:
</p>

<blockquote>
<p>
Sometimes, especially in legacy schemas, you don’t have the freedom to
include an extra discriminator column in your entity tables. In this
case, you can apply an expression <b>to calculate</b> a discriminator value
for each row.
</p>
</blockquote>

<p>
You can do that in the following way:
</p>

<div class="highlight"><pre><span></span>       <span class="c1">// on the superclass</span>
       <span class="nd">@Entity</span>
       <span class="nd">@Inheritance</span><span class="p">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">InheritanceType</span><span class="p">.</span><span class="na">SINGLE_TABLE</span><span class="p">)</span>
       <span class="nd">@org.hibernate.annotations.DiscriminatorFormula</span><span class="p">(</span>
						       <span class="s">"case when CARDNUMBER is not null then 'CC' else 'BA' end"</span>
						       <span class="p">)</span>

	   <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BillingDetails</span> <span class="p">{</span>

	       <span class="c1">// ...</span>

	   <span class="p">}</span>
</pre></div>
</li>
</ul>
</div>
</div>


<div id="outline-container-org90d7edd" class="outline-4">
<h4 id="org90d7edd">One table per subclass</h4>
<div class="outline-text-4" id="text-org90d7edd">
<p>
This is actually the most straightforward way.
</p>

<p>
The concept is that you keep all the OOP hierarchy as is and you
leverage foreign keys constraints in your relational schema that
would ultimately enforce the OOP hierachy logic.
</p>

<img src="../../images/Screenshot%202022-08-17%20160331.png" class="center"><p>
If you persist on a subclass object, Hibernate inserts two
rows. The values of properties declared by the superclass are
stored in a new row of the <i>BILLINGDETAILS</i> table. Only the
values of properties declared by the subclass are stored in a new
row of the <i>CREDITCARD</i> table.
</p>

<p>
The primary advantage of this strategy is that it <b>normalizes</b> the
SQL schema.  Schema evolution and integrity-constraint
definition are straightforward.
</p>

<p>
Note that performace can become slow with this relational schema
design. This due to the multiple join across many tables. 
</p>

<p>
This is good as with it you can reach the normal form you desire
and this should guarantee the needed consistency in the long
run. 
</p>

<p>
In order to implement this mapping strategy in Hibernate you
should work as follows:
</p>

<div class="highlight"><pre><span></span>     <span class="nd">@Entity</span>
     <span class="nd">@Inheritance</span><span class="p">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">InheritanceType</span><span class="p">.</span><span class="na">JOINED</span><span class="p">)</span>
     <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BillingDetails</span> <span class="p">{</span>

	 <span class="nd">@Id</span>
	 <span class="nd">@GeneratedValue</span><span class="p">(</span><span class="n">generator</span> <span class="o">=</span> <span class="n">Constants</span><span class="p">.</span><span class="na">ID_GENERATOR</span><span class="p">)</span>
	 <span class="kd">protected</span> <span class="n">Long</span> <span class="n">id</span><span class="p">;</span>

	 <span class="nd">@NotNull</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">owner</span><span class="p">;</span>

	 <span class="c1">// ...</span>

     <span class="p">}</span>

     <span class="c1">// Subclass</span>
     <span class="nd">@Entity</span>
     <span class="nd">@PrimaryKeyJoinColumn</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CREDITCARD_ID"</span><span class="p">)</span> <span class="c1">// specify PFK to join</span>
						   <span class="c1">// on. If you do not</span>
						   <span class="c1">// specify anything it</span>
						   <span class="c1">// will be called ID.</span>
     <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreditCard</span> <span class="kd">extends</span> <span class="n">BillingDetails</span> <span class="p">{</span>

	 <span class="nd">@NotNull</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">cardNumber</span><span class="p">;</span>

	 <span class="nd">@NotNull</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">expMonth</span><span class="p">;</span>

	 <span class="nd">@NotNull</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">expYear</span><span class="p">;</span>

	 <span class="c1">// ...</span>

     <span class="p">}</span>
</pre></div>

<p>
A <b>polymorphic query</b> would then be implemented via an outer
join.
</p>

<p>
If you see the joins - think about the situation in the
applications you are working on, then you see that this mapping
strategy is more difficult to implement by hand — even ad hoc
reporting is more complex. This is an important consideration if
you plan to mix Hibernate code with <i>handwritten SQL</i> - which
will for sure be the case in the case of legacy applications as
ours.
</p>
</div>
</div>


<div id="outline-container-org73aadbb" class="outline-4">
<h4 id="org73aadbb">On mixing mapping strategies</h4>
<div class="outline-text-4" id="text-org73aadbb">
<p>
It is possible to mix among the mapping strategies discussed
above.
</p>

<p>
This for instance to get around some downsides of a mapping
strategy; say for instance go from a table per subclass - with
union - to a normalized table-per-subclass strategy. 
</p>

<p>
Or for instance, you could have a single table with a particular
subclass in a separate table with a foreign key relation - such
that the <i>not null</i> restriction of the single table does not have
to be. For instance:
</p>

<img src="../../images/Screenshot%202022-08-18%20085954.png" class="center"><p>
You can achieve the above by:
</p>

<ul class="org-ul">
<li>using the <code>InheritanceType.SINGLE_TABLE</code> in the superclass</li>

<li>use the following annotation in the relevant subclass that you
do not want to include in the single table</li>
</ul>
<div class="highlight"><pre><span></span>     <span class="nd">@Entity</span>
     <span class="nd">@DiscriminatorValue</span><span class="p">(</span><span class="s">"CC"</span><span class="p">)</span>  <span class="c1">// as in single table strategy</span>
     <span class="nd">@SecondaryTable</span><span class="p">(</span>           <span class="c1">// here you specify a secondary table where</span>
				<span class="c1">// this object should be persisted</span>
		     <span class="n">name</span> <span class="o">=</span> <span class="s">"CREDITCARD"</span><span class="p">,</span>
		     <span class="n">pkJoinColumns</span> <span class="o">=</span> <span class="nd">@PrimaryKeyJoinColumn</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CREDITCARD_ID"</span><span class="p">)</span> <span class="c1">// PFK</span>
		     <span class="p">)</span>

     <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreditCard</span> <span class="kd">extends</span> <span class="n">BillingDetails</span> <span class="p">{</span>

	 <span class="nd">@NotNull</span>
	 <span class="nd">@Column</span><span class="p">(</span><span class="n">table</span> <span class="o">=</span> <span class="s">"CREDITCARD"</span><span class="p">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="c1">// here you</span>
							 <span class="c1">// specify the</span>
							 <span class="c1">// table where to</span>
							 <span class="c1">// persiste the</span>
							 <span class="c1">// property</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">cardNumber</span><span class="p">;</span>

	 <span class="nd">@Column</span><span class="p">(</span><span class="n">table</span> <span class="o">=</span> <span class="s">"CREDITCARD"</span><span class="p">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
	  <span class="kd">protected</span> <span class="n">String</span> <span class="n">expMonth</span><span class="p">;</span>

	 <span class="nd">@Column</span><span class="p">(</span><span class="n">table</span> <span class="o">=</span> <span class="s">"CREDITCARD"</span><span class="p">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
	 <span class="kd">protected</span> <span class="n">String</span> <span class="n">expYear</span><span class="p">;</span>
	 <span class="c1">// ...</span>
     <span class="p">}</span>
</pre></div>
</div>
</div>


<div id="outline-container-org2aa6cb0" class="outline-4">
<h4 id="org2aa6cb0">Choosing a Mapping strategy</h4>
<div class="outline-text-4" id="text-org2aa6cb0">
<p>
Here are some general guidelines from the book - quite intuitive
if you know the couple of principles behind it:
</p>

<ul class="org-ul">
<li>
<p>
If you don’t require polymorphic associations or queries, lean
toward table-per-concrete class.
</p>

<p>
Here always go with the explicit UNION-based mapping with
<code>InheritanceType.TABLE_PER_CLASS</code> should be preferred, because
(optimized) polymorphic queries and associations will then be
possible later.
</p>

<p>
Probably this will never be the case, otherwise you will not
use such OOP structure in the first place.
</p>
</li>

<li>
<p>
If you do require polymorphic associations or queries, and
subclasses declare relatively few properties lean toward
<code>InheritanceType.SINGLE_TABLE</code>.
</p>

<p>
This especially so if the main difference among subclasses is
their behaviour rather than their fields.
</p>

<p>
Here the main point is to convince yourself that <b>denormalized
schema</b> will not create any issues in the long run.
</p>
</li>

<li>If you do require polymorphic associations or queries, and
subclasses declare many <b>(non-optional)</b> properties lean toward
<code>InheritanceType.JOINED</code>.</li>
</ul>
</div>
</div>


<div id="outline-container-org9c52c09" class="outline-4">
<h4 id="org9c52c09">On the order in which to think the ORM</h4>
<div class="outline-text-4" id="text-org9c52c09">
<p>
Another open point that I am noting while writing is the
following: so far it is not clear if you should first think your
application in terms of Objects and then decide how to map it
into the DB or vice versa.
</p>

<p>
You will see this with the experice. It looks to me as if the
whole point of using such framework is as well a little bit to
think first in terms of objects, then decide for a proper mapping
strategy but then once this is done, you can as well forget the
DB and work again at application layer.
</p>
</div>
</div>


<div id="outline-container-orgbff6ec1" class="outline-4">
<h4 id="orgbff6ec1">
<span class="todo TODO">TODO</span> possibly add section on polymorphic associations</h4>
<div class="outline-text-4" id="text-orgbff6ec1">
<p>
not so well explained in the book. I think it is not conceptually
strucutred in the correct way. This section in the book is a bit
out of scope. 
</p>

<p>
Continue reading and then make sense of how to structure your
notes in this dimension. 
</p>
</div>
</div>
</div>


<div id="outline-container-org618f285" class="outline-3">
<h3 id="org618f285">
<span class="todo TODO">TODO</span> Start mapping exercise - the longrunning component</h3>
<div class="outline-text-3" id="text-org618f285">
<p>
check at it once Johannes is back.
</p>

<p>
You can start to work in ORM way in this component. 
</p>
</div>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../on-the-right-level-of-abstraction-to-think-the-system-at-high-level/" rel="prev" title="On the right level of abstraction to think the system at high level">Previous post</a>
            </li>
            <li class="next">
                <a href="../on-festina-lente/" rel="next" title="On Festina Lente">Next post</a>
            </li>
        </ul></nav></aside></article><footer id="footer"><p>Contents © 2022         <a href="mailto:marco.hassan30@gmail.com">Marco Hassan</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </section><script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(2, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>

<p>
So basically I am starting to leverage the correct stack in this
field.
</p>

<p>
This will help me to properly and quickly navigate the data.
</p>

<!-- TEASER_END -->

<p>
I am sorry but based on my experience there is really no game in
town.
</p>

<p>
For ETL and data analytics python is superior to Java. Maybe there
would be a discussion with Scala but to properly judge I would need to
take some time to explore.
</p>

<p>
This is left for a different moment.
</p>

<p>
That said I will keep my structure as follows:
</p>

<ul class="org-ul">
<li>use java for orchestrating your applications</li>

<li>use python for the actual ETL jobs</li>
</ul>

<p>
combine the two via APIs.
</p>

<p>
So now everything is ready, just waiting for the security piece in the
pipeline.
</p>

<p>
Moreover after the integration specified in this post you will be able
to move away from pure SQL. There are monster SQL that is developed in
my team.
</p>

<p>
There is little chance to explore these huge queries bit by bit..
</p>

<p>
With this set-up you will be able to:
</p>

<ul class="org-ul">
<li>fetch data from DBs</li>

<li><p>
use SQL and/or pandas native methods to transform your data
</p>

<p>
(just think about the apply methods and the rich ways to transform
your data in comparison to pure SQL)
</p></li>

<li>explore the data programatically at development time in Python</li>

<li>insert the data into DBs</li>
</ul>

<p>
No way this is not the correct stack. Everyone that tries to talk you
out of it is clearly out of track. After all the <i>just do it</i>
mentality of this team has some pros. Nobody will be able to stop you
if you deliver.
</p>

<p>
So this post briefly touches on how to properly set up the thing and
the little things that is important to consider in order to keep
everything under control in the long run.
</p>

<div id="outline-container-orge1ad649" class="outline-2">
<h2 id="orge1ad649">SQL Alchemy</h2>
<div class="outline-text-2" id="text-orge1ad649">
<p>
Note that this is important - with it you essentially have a
full-fledge toolkit to operate on SQL and have the possibility of
performing ORM mapping. Note that it is <a href="https://en.wikipedia.org/wiki/Data_mapper_pattern">similar in spirit</a> to
Hibernate so you see that despite switching languages the concepts
are very much the same across.
</p>

<p>
For me the most interesting thing of it is however the integration
with pandas. This will be the killer for me and most likely the way
I will be working in.
</p>

<p>
This rather than via ORM. Maybe I will be switch idea in time as I
will have to go in this space with Hibernate and Java in either
case and then I will be able to understand the benefits and think
if it makes sense or rather stick to a pandas approach in the
python space.
</p>
</div>

<div id="outline-container-orga60b0b5" class="outline-3">
<h3 id="orga60b0b5">Connecting to DB - Microsoft SQL Set Up</h3>
<div class="outline-text-3" id="text-orga60b0b5">
<p>
In any case, that said, the first thing to understand in this
dimension is on how to create a SQL Alchemy engine in order to
work in such a way.
</p>

<p>
We are working with Microsoft SQL Servers. So here a snippet in
order to see how to work with it. In any case there are a tons of
dialects supported by sql-alchemy and should you ever work with
other relational DBs you should be able to smoothly and swiftly
change them.
</p>

<p>
Essentially I created a python snippet in order to generate
connection strings that will be passed to the <code>pyodbc</code> driver in
order to properly set up the connection.
</p>

<p>
You can see the snippet below
</p>

<div class="highlight"><pre><span></span>    <span class="sd">&quot;&quot;&quot;Return json with the arguments in order to open a DB connection.&quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">struct</span>
    <span class="kn">from</span> <span class="nn">azure.identity</span> <span class="kn">import</span> <span class="n">DefaultAzureCredential</span>


    <span class="k">def</span> <span class="nf">connectionString</span><span class="p">(</span><span class="n">driver</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">server</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
			 <span class="n">database</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cloud</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;Return the necessary arguments in order to open a DB connection.&quot;&quot;&quot;</span>
	<span class="n">json_dump</span> <span class="o">=</span> <span class="p">{}</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">cloud</span><span class="p">:</span>

	    <span class="n">AUTHENTICATION</span> <span class="o">=</span> <span class="s2">&quot;;Trusted_Connection=yes&quot;</span> <span class="c1"># using microsoft</span>
						       <span class="c1"># integrated</span>
						       <span class="c1"># identity</span>

	    <span class="n">connstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="s2">&quot;SERVER=&quot;</span> <span class="o">+</span> <span class="n">server</span><span class="p">,</span>
					<span class="s2">&quot;DATABASE=&quot;</span> <span class="o">+</span> <span class="n">database</span><span class="p">,</span> <span class="n">AUTHENTICATION</span><span class="p">)</span>

	    <span class="n">json_dump</span><span class="p">[</span><span class="s2">&quot;connstr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connstr</span>

	    <span class="k">return</span> <span class="n">json_dump</span>

	<span class="n">default_credential</span> <span class="o">=</span> <span class="n">DefaultAzureCredential</span><span class="p">()</span>            <span class="c1"># using AAD</span>
	<span class="n">access_token</span> <span class="o">=</span> <span class="n">default_credential</span><span class="o">.</span> \
	    <span class="n">get_token</span><span class="p">(</span><span class="s1">&#39;https://database.windows.net/.default&#39;</span><span class="p">)</span>

	<span class="n">exptoken</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">access_token</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
	    <span class="n">exptoken</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">({</span><span class="n">i</span><span class="p">})</span>
	    <span class="n">exptoken</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	    <span class="n">tokenstruct</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;=i&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exptoken</span><span class="p">))</span> <span class="o">+</span> <span class="n">exptoken</span>

	<span class="n">connstr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="s2">&quot;SERVER=&quot;</span> <span class="o">+</span> <span class="n">server</span><span class="p">,</span>
				  <span class="s2">&quot;DATABASE=&quot;</span> <span class="o">+</span> <span class="n">database</span><span class="p">)</span>

	<span class="n">json_dump</span><span class="p">[</span><span class="s2">&quot;connstr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">connstr</span>
	<span class="n">json_dump</span><span class="p">[</span><span class="s2">&quot;tokenstruct&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenstruct</span>

	<span class="k">return</span> <span class="n">json_dump</span>
</pre></div>

<p>
Then this will be consumed by my applications as follows:
</p>

<div class="highlight"><pre><span></span>   <span class="c1"># Insert</span>
   <span class="n">json_conn_info</span> <span class="o">=</span> <span class="n">connectionString</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">],</span>
				     <span class="n">conn_par</span><span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">][</span><span class="s2">&quot;server&quot;</span><span class="p">],</span>
				     <span class="n">conn_par</span><span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">][</span><span class="s2">&quot;database&quot;</span><span class="p">],</span>
				     <span class="n">conn_par</span><span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">][</span><span class="s2">&quot;is_cloud&quot;</span><span class="p">])</span>

   <span class="c1"># Work with SQL Alchemy</span>
   <span class="n">params</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">json_conn_info</span><span class="p">[</span><span class="s2">&quot;connstr&quot;</span><span class="p">])</span>

   <span class="k">if</span> <span class="n">conn_par</span><span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">][</span><span class="s2">&quot;is_cloud&quot;</span><span class="p">]:</span>

       <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mssql+pyodbc:///?odbc_connect=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="p">,</span>
			      <span class="n">connect_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attrs_before&#39;</span><span class="p">:</span>
					    <span class="p">{</span><span class="mi">1256</span><span class="p">:</span>
					     <span class="n">json_conn_info</span><span class="p">[</span><span class="s2">&quot;tokenstruct&quot;</span><span class="p">]}})</span>
   <span class="k">else</span><span class="p">:</span>

       <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mssql+pyodbc:///?odbc_connect=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="p">)</span>
</pre></div>

<p>
With it you will have your engines.
</p>

<p>
You can verify that the engine is properly set up by trying to open
a connection <code>engine.connect()</code>.
</p>

<p>
You can read more about other options for setting it up <a href="https://docs.sqlalchemy.org/en/13/core/engines.html">here</a>. There
are as well the other dialects listed etc.
</p>

<p>
I will skip now to the pools, the other important bit of
configuration when setting up an engine together with the dialect.
</p>
</div>

<div id="outline-container-org75cd8aa" class="outline-4">
<h4 id="org75cd8aa">Close connections</h4>
<div class="outline-text-4" id="text-org75cd8aa">
<p>
Note that despite of working with connection pools you should
still be careful in returning the connections to the pool.
</p>

<p>
Check this <a href="https://stackoverflow.com/questions/8645250/how-to-close-sqlalchemy-connection-in-mysql">in this sense</a>.
</p>

<p>
So basically this is why you should work in the following way
when writing your code:
</p>

<div class="highlight"><pre><span></span>     <span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
	 <span class="n">df1</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">conn_par</span><span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">con</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
		    <span class="n">schema</span><span class="o">=</span><span class="n">conn_par</span><span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">][</span><span class="s2">&quot;schema&quot;</span><span class="p">],</span>
		    <span class="n">if_exists</span><span class="o">=</span><span class="n">conn_par</span><span class="p">[</span><span class="s2">&quot;insert&quot;</span><span class="p">][</span><span class="s2">&quot;if_exists&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>

<p>
Or alternatively by:
</p>

<div class="highlight"><pre><span></span>     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2000</span><span class="p">):</span>
	 <span class="n">conn</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
	 <span class="c1">#some simple data operations</span>
	 <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

<p>
When you say <code>conn.close()</code>, the connection is returned to the
connection pool within the Engine, not actually closed.
</p>

<p>
If you do want the connection to be actually closed, that is, not
pooled, disable pooling via NullPool.
</p>
</div>
</div>

<div id="outline-container-orgf5e449b" class="outline-4">
<h4 id="orgf5e449b">Disconnect Handling</h4>
<div class="outline-text-4" id="text-orgf5e449b">
<p>
You can read about it <a href="https://docs.sqlalchemy.org/en/13/core/pooling.html#connection-pool-configuration">here</a>.
</p>

<p>
It is not very well stated. I get that the default is the
following if you do not specify anything:
</p>

<blockquote>
<p>
When pessimistic handling is not employed, as well as when the
database is shutdown and/or restarted in the middle of a connection’s
period of use within a transaction, the other approach to dealing with
stale / closed connections is to let SQLAlchemy handle disconnects as
they occur, at which point all connections in the pool are
invalidated, meaning they are assumed to be stale and will be
refreshed upon next checkout.
</p>
</blockquote>

<p>
Start with it, if you get issues at some point go back there and
explore.
</p>
</div>
</div>

<div id="outline-container-org8189465" class="outline-4">
<h4 id="org8189465">Multiprocessing</h4>
<div class="outline-text-4" id="text-org8189465">
<p>
Note that if you will go on multiprocessing in python, you will
have to return <a href="https://docs.sqlalchemy.org/en/13/core/pooling.html#using-connection-pools-with-multiprocessing-or-os-fork">here</a>.
</p>

<p>
There is explained how to make the connection available across
processes. 
</p>
</div>
</div>
</div>

<div id="outline-container-org906d571" class="outline-3">
<h3 id="org906d571">ORM</h3>
<div class="outline-text-3" id="text-org906d571">
<p>
So you can check better this component when you have time.
</p>

<p>
As mentioned this will not be of paramount importance to me to
this stage as I will go the pandas way.
</p>

<p>
Might be more interesting for the DDL component of the entire
thing.
</p>
</div>
</div>

<div id="outline-container-org6a088e6" class="outline-3">
<h3 id="org6a088e6">Logging</h3>
<div class="outline-text-3" id="text-org6a088e6">
<p>
This is as well a thing that you will have to properly set up if
you want to create the thing in a proper way.
</p>

<p>
Check at the following:
</p>

<blockquote>
<p>
Python’s standard logging module is used to implement informational
and debug log output with SQLAlchemy.
</p>

<p>
This allows SQLAlchemy’s logging to integrate in a standard way with
other applications and libraries.
</p>

<p>
There are also two parameters create<sub>engine.echo</sub> and
create<sub>engine.echo</sub><sub>pool</sub> present on create<sub>engine</sub>() which allow
immediate logging to sys.stdout for the purposes of local development;
these parameters ultimately interact with the regular Python loggers
described below.
</p>
</blockquote>
</div>
</div>
</div>



<div id="outline-container-org9bbb1ef" class="outline-2">
<h2 id="org9bbb1ef">Pandas Interaction with SQL Alchemy</h2>
<div class="outline-text-2" id="text-org9bbb1ef">
<p>
So basically that is it.
</p>

<p>
SQL Alchemy is the engine through which you would ultimately
mantain the connection to the database.
</p>

<p>
You can then leverage such engine in order to interact with the
data base in the various python modules.
</p>

<p>
Think for instance at the pandas module. This is where my interest
lies.
</p>

<p>
There you have the following methods that have to well sit into
your mind. 
</p>

<ol class="org-ol">
<li><p>
<code>pd.read_sql_table</code>
</p>

<div class="highlight"><pre><span></span>      <span class="n">DataFrame</span><span class="o">.</span><span class="n">read_sql_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coerce_float</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

<p>
the important parameter is the <code>con</code> parameter.
</p>

<ul class="org-ul">
<li><p>
<code>con</code>:
</p>

<p>
SQLAlchemy connectable or str. A database URI could be
provided as str.
</p></li>
</ul>

<p>
So you see that you can provide an <code>engine.connection()</code> to it.
</p>

<p>
You then pass the table name you want to extract.
</p>

<p>
Important might also be the following:
</p>

<ul class="org-ul">
<li><code>parse_dates</code>:</li>
</ul>

<p>
List of column names to parse as dates.
</p>

<p>
Dict of <code>{column_name: format string}</code> where format string is
strftime compatible in case of parsing string times or is one of
(D, s, ns, ms, us) in case of parsing integer timestamps.
</p>

<ul class="org-ul">
<li><p>
<code>index_col</code>:
</p>

<p>
Column(s) to set as index
</p></li>

<li><p>
<code>coerce_float</code>:
</p>

<p>
Attempts to convert values of non-string, non-numeric objects
(like decimal.Decimal) to floating point. Can result in loss
of Precision.
</p></li>
</ul></li>

<li><p>
<code>df.read_sql_query</code>
</p>

<div class="highlight"><pre><span></span>      <span class="n">DataFrame</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coerce_float</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
			    <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
			    <span class="n">chunksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

<p>
Note that the arguments are pretty much the same as above.
</p>

<p>
Instead of passing a table and the corresponding schema you
actually pass a sql statement.
</p>

<p>
The other interesting argument is the following:
</p>

<ul class="org-ul">
<li><p>
<code>dtype</code>:
</p>

<p>
You pass the data type for data or columns. E.g. np.float64 or
{‘a’: np.float64, ‘b’: np.int32, ‘c’: ‘Int64’}.
</p></li>
</ul></li>

<li><p>
<code>df.to_sql</code>
</p>

<div class="highlight"><pre><span></span>      <span class="n">DataFrame</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">con</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
		       <span class="n">index_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>

<p>
This is interesting as it inserts the table into a table of
interest.
</p>

<p>
You already started using this method so you know more less the
parameters.
</p>

<p>
You have to understand the following:
</p>

<ul class="org-ul">
<li><code>index</code>: set it to <b>false</b> generally. You do not want to write
the index of your pandas dataframes to the sql table generally.</li>

<li><code>dytpe</code>: same as in the above methods.</li>

<li><code>if_exists</code>: you can say - <code>{raplace, fail, append}</code>.</li>
</ul></li>
</ol>
</div>

<div id="outline-container-orge2e40c9" class="outline-3">
<h3 id="orge2e40c9"><span class="todo TODO">TODO</span> open questions</h3>
<div class="outline-text-3" id="text-orge2e40c9">
</div>
<div id="outline-container-org7d17fbd" class="outline-4">
<h4 id="org7d17fbd">Update</h4>
<div class="outline-text-4" id="text-org7d17fbd">
<p>
So note that the above is a bit sub-optimal in the case of
update statements.
</p>

<p>
These are not provided for the data frames.
</p>

<p>
You would have to get the existing table from the db, update it
in the application logic and replace alltogether the existing
table.
</p>

<p>
You see that at performance level it is not that great.
</p>

<hr />

<p>
The alternative here is to use sql statements directly by using
the sql-alchemy engine without going through integration with
pandas.
</p>

<p>
You can still think in pandas terms and make your
transformation - in a functional way - there in order to get your
update statements.
</p>
</div>
</div>

<div id="outline-container-orgb20dd84" class="outline-4">
<h4 id="orgb20dd84">Data types</h4>
<div class="outline-text-4" id="text-orgb20dd84">
<p>
You also have to check with the data types how the situation
really is. I.e. does it always infer the data types correctly?
</p>

<p>
Can you append without big issues?
</p>

<hr />

<p>
The solution will be a trial and error case. 
</p>
</div>
</div>
</div>
</div>
